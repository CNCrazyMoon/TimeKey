# 医行项目移动前端
    当前项目已迁移到SUI,因此该文档以SUI为例进行说明
## 概述
 * SPA 和 MPA  
    当前项目以SPA+MPA混合形式,可以认为一个模块就是一个独立的SPA  
    这种形式个人认为算是比较好的页面组织结构,既不会像大型单页应用因DOM过多导致卡顿,
    也不会如MPA过于碎片化  

 * 图标字体 iconfont  
    参见[Iconfont-阿里巴巴矢量图标库](http://www.iconfont.cn/)

 * 页面布局以rem为主  
    rem相关知识,参见[web app变革之rem](https://isux.tencent.com/web-app-rem.html)
 
 * UI库 MSUI
    MSUI 参考自 Framework7, 是基于Framework7开发的一个微型版本  
[SUI Mobile](http://m.sui.taobao.org/components/)

## 目录结构
```
 -MSUI
    ├ favicon.ico 图标
    ├ images 使用到的img(png\jpg\gif)
    |   └ head.jpg
    ├ fonts 
    |  ├ iconfont.ttf 自定义的图标字体文件
    |  └ ratchicons.ttf 
    ├ article 文章模块页面、ajax页面
    |  ├ article.html 文章模块页面
    |  └ article-bake.html 文章模块版面2
    ├ js
    |  ├ sm.min.js   SUI框架js
    |  ├ sm.extend.min.js sui拓展组件
    |  ├ tk-extend.js  自实现的拓展组件
    |  ├ common.js    业务公用方法
    |  ├ access.js 权限控制
    |  └ article.js  文章模块js
    ├ css  
    |  ├ sm.min.css 
    |  ├ sm.extend.css
    |  ├ style.css
    |  └ article.css 
    └ test_lab  组件测试demo文件存放地址
          └actionsheet 
             ├ demo.html
             └ demo.js  
```

## 前端代码规范

#### css 申明顺序
声明顺序  
相关的属性声明应该以下面的顺序分组处理：  

Positioning  
Box model 盒模型  
Typographic 排版  
Visual 外观  
Positioning 处在第一位，因为他可以使一个元素脱离正常文本流，并且覆盖盒模型相关的样式。盒模型紧跟其后，因为他决定了一个组件的大小和位置。

其他属性只在组件内部起作用或者不会对前面两种情况的结果产生影响，所以他们排在后面。  

关于完整的属性以及他们的顺序，请参考 [Recess](http://twitter.github.com/recess)。  

#### JS编写建议
* 减少全局变量  
* 采用事件委托为元素注册事件  
* 尽量在html底部引入js
* 柯里化
* for循环优化
* switch优化

## 常见问题及解决办法 

### 路由相关
* a标签跳转,页面只加载一半,灰色部分正好是一个侧栏大小。
如图：  
  ![](https://github.com/CNCrazyMoon/TimeKey/raw/master/MSUI/luyou.png)

   此种情况，可能为以下情况。
  A. 在目标页面中有.page-group存在
  B. 使用了侧栏跳转，且侧栏a标签未设置，默认为ajax加载。
  解决方案（两种思路）  
  方案1.移除目标页面的.page-group div。将目标页面的css.js另行处理  
  方案2 侧栏a标签添加.external  
 
 > MSUI 路由接管了a标签的链接事件,默认为ajax加载页面。 
 > ajax加载页面就是把当前页面的div.page-group作为容器,去请求目标页面body中所有的div.page加入到
 > 当前页面div.page-group中来,加载成功后,缓存并移除当前div.page-group中的所有内容。
 > 当点击返回时,移除(可选缓存)ajax加载的页面,并将原页面内容从缓存中取出。

### 如何根据公用page动态生成page页
    引入Zepto后引入如下代码,使用$.clonePage对其进行调用
    ```javascript
    ! function($) {
      'use strict';
      /**
       - must load after or combo sm.js\sm.min.js
       - 补充动态clone page方法
       - @author zongxi.luo  
       - @param  {String} el       [欲创建的pageId]
       - @param  {String} cloneDiv [原始page]
       - @param  {String} title  [更新标题]
       - @return {object}          [新page]
       */
      $.clonePage = function(el, cloneDiv, title) {
        el = typeof(el) !== "string" ? el : el.indexOf("#") === -1 ? "#" + el : el;
        cloneDiv = typeof(cloneDiv) !== "string" ? cloneDiv : cloneDiv.indexOf("#") === -1 ? "#" + cloneDiv : cloneDiv;
        var myEl = $(el).get(0);
        var newDiv, newId;
        if (!myEl) {
          newDiv = $(cloneDiv).clone();
          if (newDiv.find("header>.title").length > 0 && title) {
            newDiv.find("header>.title").text(title);
          }
          newDiv = newDiv.get(0);
          newId = el.replace("#", "");
          newDiv.id = newId;
          if (newDiv.id !== cloneDiv) newDiv.setAttribute("data-crc", cloneDiv.replace("#", ""));
          newDiv.className = "page";
          newId = newDiv.id;
          $('.page-group').append(newDiv);
        } else {
          newDiv = myEl;
        }
        myEl = null;
        newDiv = null;
        return newId;
      };
    }(Zepto);
    ```

### 如何使用range-slider框
在MSUI下如何实现如下效果  
![](https://github.com/CNCrazyMoon/TimeKey/raw/master/MSUI/range.png)  
> 已实现该组件,引入tk_extend_actionsheet.js后, 参见样例使用

具体使用样例，参见test_lab 中的actionsheet文件夹。

[demo(内网)](http://192.168.1.96:2001/ehospital/views/MSUI/test_lab/actionsheet/demo.html)

### 事件委托多次执行
pageInit 事件是每次进入该page就会执行该方法，无论是进入还是返回该页面，都会执行。
因此 在为指定页面绑定事件的时候，可以通过以下方案：  
* 方案1. 不在pageInit中指定方法，在外面采用$(document)形式为其进行事件注册  
    ```javascript
    $(document).on('click','#page-modal .content .alert-text', fuction(){
        $.alert('这是一段提示消息');
    });

    $(document).on('click','#page-modal .content .alert-text-title', fuction(){
        $.alert('这是一段提示消息');
    });
    ```
    
* 方案2. 仍通过pageInit 中$(page)注册事件，但是为其新增一个标识位   
    
    ```javascript
    var isFirstInit = true;
    $(document).on("pageInit", "#page-modal", function(e, id, page) {
      if (isFirstInit) {
        var $content = $(page).find('.content');
        $content.on('click', '.alert-text', function() {
          $.alert('这是一段提示消息');
        });

        $content.on('click', '.alert-text-title', function() {
          $.alert('这是一段提示消息', '这是自定义的标题!');
        });
        isFirstInit = false;
      }
    });
    ```

* 方案3. 页面组织形式变更。   
如官方示例demo中,多页面共享JS\CSS, 通过ajax来加载页面. 此种情况才比较适合使用如下代码来进行事件绑定 

    ```javascript
  $(document).on("pageInit", "#page-modal", function(e, id, page) {
    var $content = $(page).find('.content');
    $content.on('click', '.alert-text', function() {
      $.alert('这是一段提示消息');
    });

    $content.on('click', '.alert-text-title', function() {
      $.alert('这是一段提示消息', '这是自定义的标题!');
    });
  });
    ```
    
    >而如果是内联页面，就不宜使用此种方式进行事件注册。

### 所有问题的解决方案
    RTFSC
## 备选项 
* 图片懒加载  
  引入lazyload.js,减少图片请求。  
* 减少请求数  
引入gulp,合并\压缩资源文件。
相关知识,参见[Gulp 中文网](http://www.gulpjs.com.cn/) 
* 正式发布,静态资源 JS\CSS 请使用.min文件
* 如果对android 原生webview 不满意,请用crosswalk